{% extends 'base.html' %}
{% load static %}

{% block title %}AI Content Generation - CloudEngineered{% endblock %}

{% block extra_css %}
<style>
    .ai-dashboard {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
    }
    
    .ai-card {
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s;
    }
    
    .ai-card:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    
    .ai-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        text-align: center;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #3b82f6;
    }
    
    .stat-label {
        font-size: 0.875rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }
    
    .generation-form {
        background: #f9fafb;
        padding: 2rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
    }
    
    .btn-ai {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        font-weight: 500;
        transition: all 0.3s;
    }
    
    .btn-ai:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        color: white;
    }
    
    .loading-spinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .content-preview {
        background: #f8fafc;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border-left: 4px solid #3b82f6;
        margin-top: 1rem;
        font-family: 'Courier New', monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .template-option {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .template-option:hover {
        border-color: #3b82f6;
    }
    
    .template-option.selected {
        border-color: #3b82f6;
        background: #eff6ff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- AI Dashboard Header -->
    <div class="ai-dashboard">
        <h1 class="text-3xl font-bold mb-4">ü§ñ AI Content Generation</h1>
        <p class="text-lg opacity-90">
            Generate high-quality content for tools, tutorials, and guides using advanced AI models.
        </p>
    </div>

    <!-- Statistics -->
    <div class="ai-stats">
        <div class="stat-card">
            <div class="stat-value" id="total-generations">---</div>
            <div class="stat-label">Total Generations</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="success-rate">---%</div>
            <div class="stat-label">Success Rate</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-tokens">---</div>
            <div class="stat-label">Tokens Used</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-cost">$--</div>
            <div class="stat-label">Total Cost</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Content Generation Form -->
        <div class="ai-card">
            <h2 class="text-2xl font-bold mb-4">üéØ Generate Content</h2>
            
            <form id="generation-form" class="generation-form">
                <!-- Content Type Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Content Type</label>
                    <div id="content-types">
                        <div class="template-option" data-type="tool_review">
                            <h3 class="font-semibold">üìù Tool Review</h3>
                            <p class="text-sm text-gray-600">Comprehensive analysis and review of development tools</p>
                        </div>
                        <div class="template-option" data-type="tutorial">
                            <h3 class="font-semibold">üìö Tutorial</h3>
                            <p class="text-sm text-gray-600">Step-by-step guides and tutorials</p>
                        </div>
                        <div class="template-option" data-type="how_to_guide">
                            <h3 class="font-semibold">üîß How-to Guide</h3>
                            <p class="text-sm text-gray-600">Practical how-to guides and instructions</p>
                        </div>
                        <div class="template-option" data-type="comparison">
                            <h3 class="font-semibold">‚öñÔ∏è Comparison</h3>
                            <p class="text-sm text-gray-600">Compare tools and technologies</p>
                        </div>
                    </div>
                </div>

                <!-- Tool Selection for Tool Reviews -->
                <div id="tool-selection" class="mb-6" style="display: none;">
                    <label for="tool-select" class="block text-sm font-medium text-gray-700 mb-2">Select Tool</label>
                    <select id="tool-select" class="w-full p-2 border border-gray-300 rounded-md">
                        <option value="">Choose a tool...</option>
                        <!-- Tools will be loaded dynamically -->
                    </select>
                </div>

                <!-- Custom Input Fields -->
                <div id="custom-inputs" class="mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                            <input type="text" id="title" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Enter content title">
                        </div>
                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                            <input type="text" id="category" class="w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., Development, DevOps">
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="description" rows="3" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Brief description or key points to include"></textarea>
                    </div>
                    
                    <div class="mt-4">
                        <label for="target-audience" class="block text-sm font-medium text-gray-700 mb-2">Target Audience</label>
                        <select id="target-audience" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate" selected>Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                </div>

                <!-- Generation Options -->
                <div class="mb-6">
                    <div class="flex items-center">
                        <input type="checkbox" id="mock-mode" class="mr-2" checked>
                        <label for="mock-mode" class="text-sm text-gray-700">Use mock mode (for testing)</label>
                    </div>
                </div>

                <button type="submit" class="btn-ai w-full">
                    <span class="loading-spinner"></span>
                    <span class="button-text">üöÄ Generate Content</span>
                </button>
            </form>
        </div>

        <!-- Generated Content Display -->
        <div class="ai-card">
            <h2 class="text-2xl font-bold mb-4">üìÑ Generated Content</h2>
            
            <div id="content-display">
                <div class="text-center text-gray-500 py-8">
                    <div class="text-4xl mb-4">ü§ñ</div>
                    <p>Generate content using the form on the left to see results here.</p>
                </div>
            </div>
            
            <!-- Content will be displayed here -->
            <div id="generation-result" style="display: none;">
                <div class="mb-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold">Generation Details</h3>
                        <button id="copy-content" class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded">
                            üìã Copy
                        </button>
                    </div>
                    <div class="text-sm text-gray-600 mt-2">
                        <span id="generation-stats"></span>
                    </div>
                </div>
                
                <div class="content-preview" id="generated-content"></div>
                
                <div class="mt-4 flex gap-2">
                    <button id="regenerate-content" class="btn-ai">
                        üîÑ Regenerate
                    </button>
                    <button id="save-content" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                        üíæ Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Generations -->
    <div class="ai-card mt-8">
        <h2 class="text-2xl font-bold mb-4">üìä Recent Generations</h2>
        <div id="recent-generations">
            <div class="text-center text-gray-500 py-4">
                <p>Loading recent generations...</p>
            </div>
        </div>
    </div>
</div>

<script>
// AI Content Generation JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('generation-form');
    const contentTypes = document.querySelectorAll('.template-option');
    const toolSelection = document.getElementById('tool-selection');
    const generationResult = document.getElementById('generation-result');
    const contentDisplay = document.getElementById('content-display');
    
    let selectedContentType = null;
    
    // Load statistics
    loadStatistics();
    
    // Load recent generations
    loadRecentGenerations();
    
    // Content type selection
    contentTypes.forEach(option => {
        option.addEventListener('click', function() {
            contentTypes.forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            selectedContentType = this.dataset.type;
            
            // Show tool selection for tool reviews
            if (selectedContentType === 'tool_review') {
                toolSelection.style.display = 'block';
                loadTools();
            } else {
                toolSelection.style.display = 'none';
            }
        });
    });
    
    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        generateContent();
    });
    
    // Copy content button
    document.getElementById('copy-content').addEventListener('click', function() {
        const content = document.getElementById('generated-content').textContent;
        navigator.clipboard.writeText(content).then(() => {
            this.textContent = '‚úÖ Copied!';
            setTimeout(() => {
                this.textContent = 'üìã Copy';
            }, 2000);
        });
    });
    
    async function generateContent() {
        if (!selectedContentType) {
            alert('Please select a content type');
            return;
        }
        
        const loading = document.querySelector('.loading-spinner');
        const buttonText = document.querySelector('.button-text');
        const submitButton = form.querySelector('button[type="submit"]');
        
        // Show loading state
        loading.style.display = 'inline-block';
        buttonText.textContent = 'Generating...';
        submitButton.disabled = true;
        
        try {
            const formData = {
                content_type: selectedContentType,
                title: document.getElementById('title').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                target_audience: document.getElementById('target-audience').value,
                mock_mode: document.getElementById('mock-mode').checked
            };
            
            // Add tool ID for tool reviews
            if (selectedContentType === 'tool_review') {
                const toolId = document.getElementById('tool-select').value;
                if (toolId) {
                    formData.tool_id = toolId;
                }
            }
            
            const response = await fetch('/ai/api/generations/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    template_id: null, // Will be determined by content_type
                    input_data: formData
                })
            });
            
            if (!response.ok) {
                throw new Error('Generation failed');
            }
            
            const result = await response.json();
            displayGeneratedContent(result);
            
        } catch (error) {
            console.error('Generation error:', error);
            alert('Content generation failed. Please try again.');
        } finally {
            // Hide loading state
            loading.style.display = 'none';
            buttonText.textContent = 'üöÄ Generate Content';
            submitButton.disabled = false;
        }
    }
    
    function displayGeneratedContent(result) {
        const generatedContent = document.getElementById('generated-content');
        const generationStats = document.getElementById('generation-stats');
        
        // Show result section
        contentDisplay.style.display = 'none';
        generationResult.style.display = 'block';
        
        // Display content
        generatedContent.textContent = result.generated_content || result.content || 'No content generated';
        
        // Display stats
        generationStats.innerHTML = `
            Tokens: ${result.tokens_used || 'N/A'} | 
            Cost: $${result.estimated_cost || 'N/A'} | 
            Time: ${result.processing_time || 'N/A'}s |
            Status: ${result.status || 'Unknown'}
        `;
        
        // Reload statistics and recent generations
        loadStatistics();
        loadRecentGenerations();
    }
    
    async function loadStatistics() {
        try {
            const response = await fetch('/ai/api/generations/statistics/');
            if (response.ok) {
                const stats = await response.json();
                document.getElementById('total-generations').textContent = stats.total_generations || 0;
                document.getElementById('success-rate').textContent = `${stats.success_rate || 0}%`;
                document.getElementById('total-tokens').textContent = stats.total_tokens_used || 0;
                document.getElementById('total-cost').textContent = `$${stats.total_cost || 0}`;
            }
        } catch (error) {
            console.error('Error loading statistics:', error);
        }
    }
    
    async function loadRecentGenerations() {
        try {
            const response = await fetch('/ai/api/generations/?limit=5');
            if (response.ok) {
                const data = await response.json();
                displayRecentGenerations(data.results || []);
            }
        } catch (error) {
            console.error('Error loading recent generations:', error);
        }
    }
    
    function displayRecentGenerations(generations) {
        const container = document.getElementById('recent-generations');
        
        if (generations.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-4"><p>No recent generations found.</p></div>';
            return;
        }
        
        const html = generations.map(gen => `
            <div class="border rounded p-3 mb-2">
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-medium">${gen.template ? gen.template.name : 'Unknown Template'}</h4>
                        <p class="text-sm text-gray-600">${gen.status_display || gen.status}</p>
                    </div>
                    <div class="text-right text-sm text-gray-500">
                        <div>${new Date(gen.created_at).toLocaleDateString()}</div>
                        <div>${gen.tokens_used || 0} tokens</div>
                    </div>
                </div>
                ${gen.generated_content ? `
                    <div class="mt-2 text-sm text-gray-700">
                        ${gen.generated_content.substring(0, 100)}...
                    </div>
                ` : ''}
            </div>
        `).join('');
        
        container.innerHTML = html;
    }
    
    async function loadTools() {
        try {
            // This would typically load from your tools API
            const toolSelect = document.getElementById('tool-select');
            toolSelect.innerHTML = `
                <option value="">Choose a tool...</option>
                <option value="3">Docker</option>
                <option value="1">VS Code</option>
                <option value="2">GitHub</option>
            `;
        } catch (error) {
            console.error('Error loading tools:', error);
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}
