{% extends "base.html" %}
{% load static %}

{% block title %}AI Tool Comparison Bot - {{ site_name }}{% endblock %}

{% block extra_css %}
<style>
    .comparison-bot-container {
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .tool-selector {
        transition: all 0.3s ease;
    }
    
    .tool-selector:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .comparison-result {
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .typing-indicator {
        display: inline-flex;
        gap: 4px;
    }
    
    .typing-indicator span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #667eea;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-10px); }
    }
    
    .markdown-content h2 {
        @apply text-2xl font-bold mt-6 mb-3 text-gray-900;
    }
    
    .markdown-content h3 {
        @apply text-xl font-semibold mt-4 mb-2 text-gray-800;
    }
    
    .markdown-content ul {
        @apply list-disc pl-6 mb-4;
    }
    
    .markdown-content ol {
        @apply list-decimal pl-6 mb-4;
    }
    
    .markdown-content p {
        @apply mb-3;
    }
    
    .markdown-content table {
        @apply w-full border-collapse mb-4;
    }
    
    .markdown-content th {
        @apply bg-gray-100 border border-gray-300 px-4 py-2 text-left font-semibold;
    }
    
    .markdown-content td {
        @apply border border-gray-300 px-4 py-2;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 py-8">
    <div class="comparison-bot-container px-4">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-3">
                🤖 AI Tool Comparison Bot
            </h1>
            <p class="text-xl text-gray-600">
                Compare any two DevOps tools with AI-powered analysis in real-time
            </p>
        </div>

        <!-- Main Comparison Interface -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Left Sidebar - Tool Selection -->
            <div class="lg:col-span-4">
                <div class="bg-white rounded-lg shadow-lg p-6 sticky top-4">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">
                        Select Tools to Compare
                    </h2>
                    
                    <!-- Tool 1 Selector -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            First Tool
                        </label>
                        <select id="tool1Select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">-- Select First Tool --</option>
                            {% for tool in tools %}
                                <option value="{{ tool.id }}" data-category="{{ tool.category.name }}">
                                    {{ tool.name }} ({{ tool.category.name }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- VS Divider -->
                    <div class="text-center my-4">
                        <span class="inline-block bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold px-6 py-2 rounded-full text-lg">
                            VS
                        </span>
                    </div>

                    <!-- Tool 2 Selector -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Second Tool
                        </label>
                        <select id="tool2Select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">-- Select Second Tool --</option>
                            {% for tool in tools %}
                                <option value="{{ tool.id }}" data-category="{{ tool.category.name }}">
                                    {{ tool.name }} ({{ tool.category.name }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Query Input -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            What would you like to know?
                        </label>
                        <textarea 
                            id="userQuery" 
                            rows="3" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="E.g., Which is better for small teams? What are the main differences? How do they compare in performance?"
                        ></textarea>
                        <div id="querySuggestions" class="mt-2 space-y-1"></div>
                    </div>

                    <!-- Optional Context -->
                    <div class="mb-6">
                        <button 
                            id="showContextBtn" 
                            type="button"
                            class="text-sm text-blue-600 hover:text-blue-800 font-medium"
                        >
                            + Add context (optional)
                        </button>
                        <div id="contextFields" class="hidden mt-3 space-y-3">
                            <input 
                                type="text" 
                                id="contextUseCase" 
                                placeholder="Use case (e.g., CI/CD for microservices)"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                            >
                            <input 
                                type="text" 
                                id="contextTeamSize" 
                                placeholder="Team size (e.g., 5-10 developers)"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                            >
                            <input 
                                type="text" 
                                id="contextBudget" 
                                placeholder="Budget (e.g., <$500/month)"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                            >
                        </div>
                    </div>

                    <!-- Compare Button -->
                    <button 
                        id="compareBtn"
                        class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-4 px-6 rounded-lg hover:from-blue-700 hover:to-purple-700 transform hover:scale-105 transition-all duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                        disabled
                    >
                        <span id="compareBtnText">
                            <svg class="inline h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                            Compare Tools with AI
                        </span>
                    </button>

                    <!-- Quick Comparison Option -->
                    <button 
                        id="quickCompareBtn"
                        class="w-full mt-3 bg-white border-2 border-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg hover:bg-gray-50 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        Quick Compare (Fast)
                    </button>
                </div>

                <!-- Recent Comparisons -->
                {% if recent_comparisons %}
                <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-3">Recent Comparisons</h3>
                    <div class="space-y-2">
                        {% for comparison in recent_comparisons %}
                        <button 
                            class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition-colors load-comparison"
                            data-tool1="{{ comparison.tool1.id }}"
                            data-tool2="{{ comparison.tool2.id }}"
                        >
                            {{ comparison.tool1.name }} vs {{ comparison.tool2.name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Right Content - Comparison Results -->
            <div class="lg:col-span-8">
                <!-- Welcome State -->
                <div id="welcomeState" class="bg-white rounded-lg shadow-lg p-12 text-center">
                    <div class="max-w-2xl mx-auto">
                        <div class="text-6xl mb-6">🤖✨</div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-4">
                            Welcome to AI Tool Comparison
                        </h2>
                        <p class="text-lg text-gray-600 mb-8">
                            Select two tools from the left sidebar and ask any question. Our AI will generate a comprehensive, real-time comparison tailored to your needs.
                        </p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-left">
                            <div class="bg-blue-50 rounded-lg p-6">
                                <div class="text-3xl mb-3">⚡</div>
                                <h3 class="font-bold text-gray-900 mb-2">Real-Time Analysis</h3>
                                <p class="text-sm text-gray-600">Get instant AI-powered comparisons generated on demand</p>
                            </div>
                            <div class="bg-purple-50 rounded-lg p-6">
                                <div class="text-3xl mb-3">🎯</div>
                                <h3 class="font-bold text-gray-900 mb-2">Contextual Insights</h3>
                                <p class="text-sm text-gray-600">Add your specific context for personalized recommendations</p>
                            </div>
                            <div class="bg-pink-50 rounded-lg p-6">
                                <div class="text-3xl mb-3">📊</div>
                                <h3 class="font-bold text-gray-900 mb-2">Detailed Breakdown</h3>
                                <p class="text-sm text-gray-600">Comprehensive analysis with features, pricing, and use cases</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="hidden bg-white rounded-lg shadow-lg p-12">
                    <div class="text-center">
                        <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mb-6 animate-pulse">
                            <svg class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-3">
                            Analyzing Tools...
                        </h3>
                        <p class="text-gray-600 mb-4" id="loadingMessage">
                            AI is generating your comparison
                        </p>
                        <div class="typing-indicator justify-center">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <p class="text-sm text-gray-500 mt-6">
                            This may take 10-30 seconds...
                        </p>
                    </div>
                </div>

                <!-- Results State -->
                <div id="resultsState" class="hidden">
                    <!-- Comparison Header -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900" id="comparisonTitle">
                                    Comparison Results
                                </h2>
                                <p class="text-sm text-gray-500 mt-1">
                                    Generated in <span id="processingTime">0</span>s using AI
                                </p>
                            </div>
                            <button 
                                id="newComparisonBtn"
                                class="px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold rounded-lg transition-colors"
                            >
                                New Comparison
                            </button>
                        </div>
                    </div>

                    <!-- Comparison Content -->
                    <div class="bg-white rounded-lg shadow-lg p-8">
                        <div id="comparisonContent" class="markdown-content prose max-w-none">
                            <!-- AI-generated content will be inserted here -->
                        </div>
                    </div>

                    <!-- Feedback Section -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Was this comparison helpful?</h3>
                        <div class="flex items-center gap-4">
                            <button 
                                class="feedback-btn px-6 py-3 bg-green-100 hover:bg-green-200 text-green-800 font-semibold rounded-lg transition-colors"
                                data-helpful="true"
                            >
                                👍 Yes, helpful
                            </button>
                            <button 
                                class="feedback-btn px-6 py-3 bg-red-100 hover:bg-red-200 text-red-800 font-semibold rounded-lg transition-colors"
                                data-helpful="false"
                            >
                                👎 Not helpful
                            </button>
                        </div>
                        <div id="feedbackThanks" class="hidden mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg text-blue-800">
                            Thank you for your feedback! It helps us improve.
                        </div>
                    </div>
                </div>

                <!-- Error State -->
                <div id="errorState" class="hidden bg-white rounded-lg shadow-lg p-12">
                    <div class="text-center">
                        <div class="text-6xl mb-6">😕</div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-3">
                            Oops! Something went wrong
                        </h3>
                        <p class="text-gray-600 mb-6" id="errorMessage">
                            We couldn't generate the comparison. Please try again.
                        </p>
                        <button 
                            id="retryBtn"
                            class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors"
                        >
                            Try Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
let currentComparisonId = null;

console.log('Comparison bot initialized');

// Show/hide context fields
document.getElementById('showContextBtn').addEventListener('click', function() {
    const contextFields = document.getElementById('contextFields');
    contextFields.classList.toggle('hidden');
    this.textContent = contextFields.classList.contains('hidden') 
        ? '+ Add context (optional)' 
        : '- Hide context';
});

// Enable/disable compare button based on tool selection
function updateCompareButton() {
    const tool1 = document.getElementById('tool1Select').value;
    const tool2 = document.getElementById('tool2Select').value;
    const compareBtn = document.getElementById('compareBtn');
    const quickBtn = document.getElementById('quickCompareBtn');
    
    const canCompare = tool1 && tool2 && tool1 !== tool2;
    compareBtn.disabled = !canCompare;
    quickBtn.disabled = !canCompare;
    
    // Load suggestions if both tools selected
    if (canCompare) {
        loadSuggestions(tool1, tool2);
    }
}

document.getElementById('tool1Select').addEventListener('change', updateCompareButton);
document.getElementById('tool2Select').addEventListener('change', updateCompareButton);

// Load comparison suggestions
async function loadSuggestions(tool1Id, tool2Id) {
    try {
        const response = await fetch(`/tools/compare/suggestions/?tool1_id=${tool1Id}&tool2_id=${tool2Id}`);
        const data = await response.json();
        
        if (data.success && data.suggestions) {
            const container = document.getElementById('querySuggestions');
            container.innerHTML = data.suggestions.slice(0, 3).map(q => 
                `<button class="text-xs text-blue-600 hover:text-blue-800 hover:underline suggestion-btn" data-query="${q}">
                    💡 ${q}
                </button>`
            ).join('');
            
            // Add click handlers
            document.querySelectorAll('.suggestion-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.getElementById('userQuery').value = this.dataset.query;
                });
            });
        }
    } catch (error) {
        console.error('Error loading suggestions:', error);
    }
}

// Show/hide states
function showState(stateName) {
    ['welcomeState', 'loadingState', 'resultsState', 'errorState'].forEach(state => {
        document.getElementById(state).classList.add('hidden');
    });
    document.getElementById(stateName).classList.remove('hidden');
}

// Compare tools
document.getElementById('compareBtn').addEventListener('click', async function() {
    console.log('Compare button clicked');
    await performComparison(false);
});

document.getElementById('quickCompareBtn').addEventListener('click', async function() {
    console.log('Quick compare button clicked');
    await performComparison(true);
});

async function performComparison(quick = false) {
    console.log('performComparison called, quick:', quick);
    const tool1Id = document.getElementById('tool1Select').value;
    const tool2Id = document.getElementById('tool2Select').value;
    const query = document.getElementById('userQuery').value || 'Compare these tools comprehensively';
    
    console.log('Tool IDs:', tool1Id, tool2Id);
    console.log('Query:', query);
    
    const context = {
        use_case: document.getElementById('contextUseCase')?.value || '',
        team_size: document.getElementById('contextTeamSize')?.value || '',
        budget: document.getElementById('contextBudget')?.value || ''
    };
    
    showState('loadingState');
    
    const endpoint = quick ? '/tools/compare/quick/' : '/tools/compare/generate/';
    
    console.log('Sending request to:', endpoint);
    
    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                tool1_id: tool1Id,
                tool2_id: tool2Id,
                query: query,
                context: context
            })
        });
        
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
            currentComparisonId = data.comparison_id;
            displayComparison(data);
        } else {
            console.error('Comparison failed:', data.error);
            showError(data.error || 'Failed to generate comparison');
        }
    } catch (error) {
        console.error('Error during comparison:', error);
        showError('Network error. Please try again.');
    }
}

// Display comparison results
function displayComparison(data) {
    const title = `${data.tool1.name} vs ${data.tool2.name}`;
    document.getElementById('comparisonTitle').textContent = title;
    document.getElementById('processingTime').textContent = data.processing_time || '?';
    
    const content = data.result.full_text || data.result.summary || 'No content available';
    const contentHtml = marked.parse(content);
    document.getElementById('comparisonContent').innerHTML = contentHtml;
    
    showState('resultsState');
}

// Show error
function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    showState('errorState');
}

// Retry button
document.getElementById('retryBtn').addEventListener('click', function() {
    showState('welcomeState');
});

// New comparison button
document.getElementById('newComparisonBtn').addEventListener('click', function() {
    showState('welcomeState');
    currentComparisonId = null;
});

// Feedback buttons
document.querySelectorAll('.feedback-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        if (!currentComparisonId) return;
        
        const helpful = this.dataset.helpful === 'true';
        
        try {
            const response = await fetch('/tools/compare/feedback/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    comparison_id: currentComparisonId,
                    helpful: helpful
                })
            });
            
            if (response.ok) {
                document.getElementById('feedbackThanks').classList.remove('hidden');
                document.querySelectorAll('.feedback-btn').forEach(b => b.disabled = true);
            }
        } catch (error) {
            console.error('Error submitting feedback:', error);
        }
    });
});

// Load comparison from history
document.querySelectorAll('.load-comparison').forEach(btn => {
    btn.addEventListener('click', function() {
        document.getElementById('tool1Select').value = this.dataset.tool1;
        document.getElementById('tool2Select').value = this.dataset.tool2;
        updateCompareButton();
    });
});

// CSRF token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

}); // End DOMContentLoaded
</script>
{% endblock %}
